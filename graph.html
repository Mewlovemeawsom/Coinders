<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>สรุป</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    margin: 0;
    font-family: 'Kanit', sans-serif;
    background: #f3f3f3;
    padding-bottom: 70px; 
  }
  
  h1 {
    text-align: center;
    color: #124170; 
    margin-top: 16px; 
  }
  
  /* --- Tabs Style (ปุ่ม ทั่วไป/รายจ่าย/รายรับ) --- */
  .tabs {
    display: flex;
    gap: 0; 
    margin: 16px auto; 
    width: 90%; 
    max-width: 400px;
    background: #67C090; 
    border-radius: 999px; 
    padding: 4px; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
  }
  .tabs button {
    flex-grow: 1; 
    border: none;
    padding: 8px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    background: transparent; 
    color: #fff; 
    font-weight: 600; 
    white-space: nowrap; 
  }
  .tabs .active {
    background: #154360; 
    color: #fff;
  }

  /* --- Filters Style (ปุ่มกรอง: วันที่) --- */
  .filters {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 8px;
    flex-wrap: wrap;
    padding: 0 16px; 
  }

  /* สไตล์พื้นฐาน (Inactive) - ปุ่มสีเทาอ่อน */
  .filters button {
    background: #E0E0E0; 
    color: #555; 
    border: none; 
    padding: 8px 16px; 
    border-radius: 999px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
    display: flex; 
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
    line-height: 1.2;
    white-space: normal;
    text-align: center;
  }
  
  /* สไตล์ปุ่มที่ถูกเลือก (Active Filter) - สีเขียวอ่อน */
  .filters .active-filter {
    background: #DDF4E7; 
    color: #67C090; 
    border: 1px solid #66BB6A; 
    padding: 7px 15px; 
  }
  
  /* NEW: Style สำหรับข้อความภายในปุ่ม Filter - ถูกปรับให้แสดงผลเดียวเท่านั้น */
  .filter-text-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 600;
  }
  /* NEW: ลบ Style ที่ใช้แสดงจำนวนเงินในปุ่ม */
  .filter-amount-display,
  .filter-amount-positive,
  .filter-amount-negative {
      display: none;
  }


  .filters button svg {
    width: 18px;
    height: 18px;
    color: inherit; 
  }
  
  /* --- Card & Chart Area (สำหรับ Tab 'ทั่วไป') --- */
  .card {
    background: #fff;
    margin: 16px;
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .card-header {
    display: flex;
    flex-direction: column; 
    align-items: flex-start; 
    gap: 4px; 
    margin-bottom: 16px;
  }

  .card-header .summary-line {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card-header .title {
    font-size: 18px;
    color: #333;
  }
  
  /* NEW: Style สำหรับยอดรวมคงเหลือ */
  .net-amount-display {
    font-size: 16px;
    padding: 4px 8px;
    border-radius: 8px;
    margin-left: 10px;
    white-space: nowrap;
    color: #333;
  }
  .net-positive {
    background: #DDF4E7; /* สีเขียวอ่อน */
  }
  .net-negative {
    background: #FFE2E2; /* สีแดงอ่อน */
  }
  /* [ลบจำนวนเงิน] - ซ่อนข้อความจำนวนเงินสุทธิเดิม */
  .total-amount, .net-negative-old {
    display: none; 
  }

  .card-header .item-count {
    font-size: 14px;
    color: #888;
  }

  .chart-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 10px 0;
    max-width: 300px;
    height: 300px; 
    margin-left: auto;
    margin-right: auto;
  }

  .card-summary {
    margin-top: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px; 
  }

  .income-box, .expense-box {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 12px; 
    padding: 12px 16px;
    font-weight: 500;
  }
  /* NEW: สีพื้นหลังตามโจทย์ (DDF4E7 และ FFE2E2) */
  .income-box {
    background: #DDF4E7; 
    color: #1b5e20; 
  }
  .expense-box {
    background: #FFE2E2; 
    color: #c62828; 
  }
  
  .income-box > div, .expense-box > div {
    display: flex;
    flex-direction: column;
    text-align: left;
  }
  
  /* NEW: แสดงจำนวนเงินรายรับ/รายจ่าย */
  .amount-display {
    font-size: 18px;
    white-space: nowrap;
  }
  .income-box strong {
    color: #1b5e20; 
  }
  .expense-box strong {
    color: #c62828; 
  }
  
  .income-box p, .expense-box p {
    margin: 0;
    font-size: 16px;
  }
  .income-box small, .expense-box small {
    font-size: 12px;
    margin-top: 2px;
  }
  
  /* [ลบจำนวนเงิน] - ซ่อนจำนวนเงินเดิม */
  .income-box strong:not(.amount-display), 
  .expense-box strong:not(.amount-display) {
    display: none;
  }
  
  /* --- Content Styles for 'รายจ่าย'/'รายรับ' --- */
  .category-card {
    background: #fff;
    margin: 16px;
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .category-header {
    margin-bottom: 12px;
  }

  .category-header h2 {
    font-size: 20px;
    color: #333;
    margin: 0 0 4px 0;
  }

  .category-header .summary-line {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .category-header .count {
    font-size: 14px;
    color: #888;
  }
  
  /* NEW: Style สำหรับรายการหมวดหมู่ (เช่น อาหาร 205 THB) */
  .category-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
  }

  .category-item:last-child {
    border-bottom: none;
  }

  .category-item-details {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .category-item-details svg {
    width: 24px;
    height: 24px;
  }
  
  .category-item .icon-bg {
    padding: 6px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Expense Colors */
  .category-item.expense .icon-bg {
    color: #C62828; 
  }
  
  /* Income Colors */
  .category-item.income .icon-bg {
    color: #1b5e20; 
  }

  .category-item .name {
    display: flex;
    flex-direction: column;
    line-height: 1.2;
  }
  
  .category-item .name span {
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }
  
  .category-item .name small {
    font-size: 13px;
    color: #888;
  }

  /* NEW: แสดงจำนวนเงินในรายการหมวดหมู่ */
  .category-item .amount-display {
    font-size: 16px;
    font-weight: 600;
  }
  
  .category-item.expense .amount-display {
    color: #C62828;
  }
  
  .category-item.income .amount-display {
    color: #1b5e20;
  }

  .category-item .amount {
    display: none; /* ซ่อน amount เก่า */
  }

  /* --- Calendar View Styles --- */
  #calendar-view {
    background: #f3f3f3; 
    padding-top: 48px;
    min-height: 100vh;
  }
  
  .calendar-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 48px;
    background: #fff;
    display: flex;
    align-items: center;
    padding: 0 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    z-index: 100;
  }

  .calendar-header .back-button {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    color: #154360; 
    margin-right: 16px;
    display: flex;
  }
  .calendar-header .back-button svg {
    width: 24px;
    height: 24px;
    transform: rotate(180deg);
  }

  .calendar-header .title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    flex-grow: 1;
    text-align: center;
    margin-left: -40px;
  }

  .calendar-card {
    background: #fff;
    margin: 16px;
    border-radius: 16px;
    padding: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .month-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 8px 4px;
    border-bottom: 1px solid #eee;
  }
  
  .month-header .month-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  /* NEW: Style สำหรับยอดรวมรายเดือนในปฏิทิน */
  .month-summary {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    font-size: 14px;
    line-height: 1.2;
    font-weight: 500;
  }
  .month-summary .income-text {
    color: #1b5e20;
  }
  .month-summary .expense-text {
    color: #C62828;
  }
  .month-summary .net-text {
    color: #333;
  }
  
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-size: 14px;
  }

  .day-header {
    color: #888;
    padding: 8px 0;
  }
  
  .day-cell {
    border: 1px solid #eee;
    height: 60px; /* เพิ่มความสูงรองรับตัวเลข */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 4px 0;
    position: relative;
    color: #333;
    font-weight: 500;
  }

  .day-cell .date-num {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 2px;
  }
  
  /* FIX: แสดงจำนวนเงินจริงในช่องปฏิทิน */
  .day-cell .income-value,
  .day-cell .expense-value {
    display: block;
    font-size: 9px;
    line-height: 1.1;
    font-weight: 600;
    white-space: nowrap;
  }

  .day-cell .income-value {
    color: #1b5e20; 
  }
  .day-cell .expense-value {
    color: #C62828; 
  }
  
  .day-cell.inactive-month {
    color: #bbb;
    background: #fafafa;
  }
  
  .day-cell.current-date {
    background-color: #E0F2E9; 
    border: 1px solid #66BB6A;
  }
  
  /* --- Bottom Navigation Styles (ไม่เปลี่ยนแปลง) --- */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #67C090; 
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    z-index: 1000;
  }
  .nav-icon {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px;
    cursor: pointer;
    color: #FFFFFF; 
    transition: color 0.3s;
  }
  .nav-icon svg {
    display: block;
    width: 24px;
    height: 24px;
  }
  .active-icon {
    color: #124170; 
  }
</style>
</head>
<body>

<div id="summary-view">
  <h1>สรุป</h1>

  <div class="tabs">
    <button class="active" onclick="setActiveTab(this, 'all')">ทั่วไป</button> 
    <button onclick="setActiveTab(this, 'expense')">รายจ่าย</button>
    <button onclick="setActiveTab(this, 'income')">รายรับ</button>
  </div>

  <div class="filters" id="date-filters">
    <button class="active-filter" onclick="setActiveFilter(this, 'all')">ทั้งหมด</button>
    <button id="today-filter-btn" onclick="setActiveFilter(this, 'today')">
      วันนี้
    </button>
    <button id="month-filter-btn" onclick="setActiveFilter(this, 'month')">
      เดือนปัจจุบัน
    </button> 
    <button onclick="setActiveFilter(this, 'calendar')">
      ปฏิทิน 
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M19 4h-2V3a1 1 0 0 0-2 0v1H9V3a1 1 0 0 0-2 0v1H5a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3m1 15a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-7h16Zm0-9H4V7a1 1 0 0 1 1-1h2v1a1 1 0 0 0 2 0V6h6v1a1 1 0 0 0 2 0V6h2a1 1 0 0 1 1 1Z"/></svg>
    </button>
  </div>
  
  <div id="all-content">
    <div class="card">
      <div class="card-header">
        <span class="title" id="filter-title">ทั้งหมด</span>
        <div class="summary-line">
          <span class="item-count" id="item-count">0 รายการ</span>
          <span class="net-amount-display" id="net-amount-display"></span>
          <span class="total-amount" id="total-amount">0 THB</span> 
        </div>
      </div>
      
      <div class="chart-container">
        <canvas id="myChart" style="max-width: 100%;"></canvas>
      </div>
      
      <div class="card-summary">
        <div class="income-box">
          <div>
            <p>รายรับ</p>
            <small id="income-count">0 รายการ</small>
          </div>
          <strong class="amount-display" id="income-amount-display">0 THB</strong>
          <strong id="income-amount">0 THB</strong>
        </div>
        <div class="expense-box">
          <div>
            <p>รายจ่าย</p>
            <small id="expense-count">0 รายการ</small>
          </div>
          <strong class="amount-display" id="expense-amount-display">0 THB</strong>
          <strong id="expense-amount">0 THB</strong>
        </div>
      </div>
    </div>
  </div>
  
  <div id="expense-content" style="display:none;">
    <div class="category-card">
      <div class="category-header">
        <h2>รายจ่าย</h2>
        <div class="summary-line">
          <span class="count" id="expense-category-count">0 รายการ</span>
          <span class="net-negative" style="display: none;">0 THB</span> 
        </div>
      </div>
      
      <div class="category-list" id="expense-category-list">
        <p style="text-align: center; color: #777; margin-top: 20px;">ยังไม่มีรายการรายจ่ายที่ถูกบันทึก</p>
      </div>
    </div>
  </div>
  
  <div id="income-content" style="display:none;">
    <div class="category-card">
      <div class="category-header">
        <h2>รายรับ</h2>
        <div class="summary-line">
          <span class="count" id="income-category-count">0 รายการ</span>
          <span class="total-amount" style="display: none;">0 THB</span> 
        </div>
      </div>
      
      <div class="category-list" id="income-category-list">
        <p style="text-align: center; color: #777; margin-top: 20px;">ยังไม่มีรายการรายรับที่ถูกบันทึก</p>
      </div>
    </div>
  </div>

</div>

<div id="calendar-view" style="display:none;">
  <div class="calendar-header">
    <button class="back-button" onclick="showSummaryView()">
      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="24" viewBox="0 0 12 24">
        <path fill="currentColor" fill-rule="evenodd" d="M10.157 12.711L4.5 18.368l-1.414-1.414l4.95-4.95l-4.95-4.95L4.5 5.64l5.657 5.657a1 1 0 0 1 0 1.414"/>
      </svg>
    </button>
    <span class="title">ปฏิทิน</span>
  </div>
  
  <div id="calendar-cards-container">
    
    </div>
</div>

<div class="bottom-nav">
  <a href="hello.html">
    <div class="nav-icon" onclick="setActiveIcon(this)">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
            <path d="m3 9l9-7l9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z"/><path d="M9 22V12h6v10"/>
        </g>
    </svg>
  </div>
  </a>

  <a href="List.html">
    <div class="nav-icon" onclick="setActiveIcon(this)"> 
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
      <path fill="currentColor" d="M3 5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2zm6 0H5v4h4zm4 0a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2zm6 0h-4v4h4zM3 15a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2zm6 0H5v4h4zm4 0a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2zm6 0h-4v4h4z"/>
    </svg>
  </div>
  </a>

  <a href="graph.html">
    <div class="nav-icon active-icon" onclick="setActiveIcon(this)">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <path fill="currentColor" d="M2.7 17.625q-.3-.3-.288-.712t.288-.688l5.275-5.35Q8.55 10.3 9.4 10.3t1.425.575l2.575 2.6l5.2-5.15H17q-.425 0-.712-.288T16 7.326t.288-.712t.712-.288h4q.425 0 .713.288t.287.712v4q0 .425-.288.713t-.712.287t-.712-.287t-.288-.713v-1.6L14.825 14.9q-.575.575-1.425.575t-1.425-.575L9.4 12.325l-5.3 5.3q-.275.275-.7.275t-.7-.275"/>
      </svg>
    </div>
  </a>

  <a href="Profile.html">
    <div class="nav-icon" onclick="setActiveIcon(this)">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <path fill="currentColor" d="M4 18q-.425 0-.712-.288T3 17t.288-.712T4 16h16q.425 0 .713.288T21 17t-.288.713T20 18zM4 13q-.425 0-.712-.288T3 12t.288-.712T4 11h16q.425 0 .713.288T21 12t-.288.713T20 13zM4 8q-.425 0-.712-.288T3 7t.288-.712T4 6h16q.425 0 .713.288T21 7t-.288.713T20 8z"/>
      </svg>
    </div>
  </a>

</div>

<script>
// *** 1. ดึงข้อมูลจริงจาก Local Storage ***
const TRANSACTIONS_KEY = 'transactions';
function getTransactions() {
    const json = localStorage.getItem(TRANSACTIONS_KEY);
    const transactions = json ? JSON.parse(json) : [];
    
    // Month Map ที่สมบูรณ์
    const monthMap = { "ม.ค.": 0, "ก.พ.": 1, "มี.ค.": 2, "เม.ย.": 3, "พ.ค.": 4, "มิ.ย.": 5, "ก.ค.": 6, "ส.ค.": 7, "ก.ย.": 8, "ต.ค.": 9, "พ.ย.": 10, "ธ.ค.": 11 };

    return transactions.map(t => {
        const parts = t.date ? t.date.split(' ') : [];
        let dateObj = null;

        if (parts.length === 3) {
            const day = parseInt(parts[0]);
            const monthIndex = monthMap[parts[1]];
            const year = parseInt(parts[2]);
            if (!isNaN(day) && monthIndex !== undefined && !isNaN(year)) {
                 dateObj = new Date(year, monthIndex, day);
            }
        }
        
        return {
            ...t,
            amount: parseFloat(t.amount) || 0,
            date: dateObj || new Date()
        };
    });
}

// ฟังก์ชันสำหรับคำนวณยอดรวมจาก transactions
function calculateSummary(filteredTransactions) {
    let incomeSum = 0;
    let expenseSum = 0;
    
    filteredTransactions.forEach(t => {
        if (t.type === 'income') {
            incomeSum += t.amount;
        } else if (t.type === 'expense') {
            expenseSum += t.amount;
        }
    });
    
    const netAmount = incomeSum - expenseSum;
    
    return {
        itemCount: filteredTransactions.length,
        incomeAmount: incomeSum,
        expenseAmount: expenseSum,
        netAmount: netAmount,
        netAmountClass: netAmount >= 0 ? 'net-positive' : 'net-negative', 
        incomeCount: filteredTransactions.filter(t => t.type === 'income').length,
        expenseCount: filteredTransactions.filter(t => t.type === 'expense').length,
        chartData: [incomeSum, expenseSum],
        
        // NEW: จัดกลุ่มตามหมวดหมู่เพื่อแสดงในแท็บรายจ่าย/รายรับ
        categories: filteredTransactions.reduce((acc, t) => {
            if (!acc[t.category]) {
                acc[t.category] = { category: t.category, count: 0, sum: 0, iconHtml: t.iconHtml, type: t.type };
            }
            acc[t.category].count++;
            acc[t.category].sum += t.amount;
            return acc;
        }, {})
    };
}

// โหลดและคำนวณข้อมูลเริ่มต้นทั้งหมด
const allRawTransactions = getTransactions();
const allData = calculateSummary(allRawTransactions);

// ตัวแปรเก็บข้อมูลสำหรับแต่ละ Filter Key
const filterData = {
    'all': allData,
    'today': calculateSummary(allRawTransactions.filter(t => {
        const today = new Date();
        return t.date.getDate() === today.getDate() &&
               t.date.getMonth() === today.getMonth() &&
               t.date.getFullYear() === today.getFullYear();
    })),
    'month': calculateSummary(allRawTransactions.filter(t => {
        const today = new Date();
        return t.date.getMonth() === today.getMonth() &&
               t.date.getFullYear() === today.getFullYear();
    }))
};

let currentActiveTab = 'all'; 
let currentActiveFilter = 'all'; 
let myChart; 

// ข้อมูลเดือนภาษาไทย
const monthNames = [
  "ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.",
  "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."
];

// NEW: ฟังก์ชันสร้างรายการหมวดหมู่เดียว
function createCategoryItem(categoryData) {
    const isExpense = categoryData.type === 'expense';
    const iconColor = isExpense ? '#C62828' : '#1b5e20';
    const totalAmount = categoryData.sum.toLocaleString('th-TH');
    
    const fallbackIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>';
    const displayIconHtml = categoryData.iconHtml && categoryData.iconHtml.trim() ? categoryData.iconHtml : fallbackIcon;

    return `
        <div class="category-item ${categoryData.type}">
            <div class="category-item-details">
                <div class="icon-bg" style="color: ${iconColor};">
                    ${displayIconHtml}
                </div>
                <div class="name">
                    <span>${categoryData.category}</span>
                    <small>${categoryData.count} รายการ</small>
                </div>
            </div>
            <strong class="amount-display">${totalAmount} THB</strong>
            <div class="amount"></div>
        </div>
    `;
}

// NEW: ฟังก์ชันแสดงเนื้อหาในแท็บรายจ่าย/รายรับ
function renderCategoryContent(tabType, filterKey) {
    const data = filterData[filterKey] || allData;
    const isExpense = tabType === 'expense';
    
    const categoryListElement = document.getElementById(`${tabType}-category-list`);
    const countElement = document.getElementById(`${tabType}-category-count`);
    
    const categoriesArray = Object.values(data.categories)
        .filter(cat => cat.type === tabType)
        .sort((a, b) => b.sum - a.sum); // เรียงตามยอดรวมมากไปน้อย
        
    const totalItems = categoriesArray.reduce((sum, cat) => sum + cat.count, 0);

    if (totalItems === 0) {
        categoryListElement.innerHTML = `<p style="text-align: center; color: #777; margin-top: 20px;">ยังไม่มีรายการ${isExpense ? 'รายจ่าย' : 'รายรับ'}ที่ถูกบันทึก</p>`;
    } else {
        categoryListElement.innerHTML = categoriesArray.map(createCategoryItem).join('');
    }
    
    // อัปเดตจำนวนรายการรวม
    countElement.textContent = `${totalItems} รายการ`;
}

// ฟังก์ชันสร้าง HTML สำหรับแสดงจำนวนเงินบนปุ่ม Filter
function formatAmountForFilterBtn(netAmount) {
    const formattedAmount = netAmount.toLocaleString('th-TH');
    const colorClass = netAmount >= 0 ? 'filter-amount-positive' : 'filter-amount-negative'; 
    
    // [FIX] ลบคลาสที่ใช้แสดงจำนวนเงินออก
    return ''; 
}

function updateFilterButtonAmounts() {
    // 1. Get filtered data
    const todayData = filterData['today'];
    const monthData = filterData['month'];
    const today = new Date();

    // 2. Update Today button (แสดงเฉพาะ "วันนี้")
    const todayBtn = document.getElementById('today-filter-btn');
    if (todayBtn) {
        todayBtn.innerHTML = `วันนี้`; 
    }

    // 3. Update Month button (แสดงเฉพาะ "เดือนปัจจุบัน")
    const monthBtn = document.getElementById('month-filter-btn');
    if (monthBtn) {
        const monthYearText = `${monthNames[today.getMonth()]} ${today.getFullYear() + 543}`;
        monthBtn.innerHTML = `${monthYearText}`;
    }
}


// ฟังก์ชันสำหรับอัปเดตข้อมูลใน Card และ Chart (สำหรับ Tab 'ทั่วไป' เท่านั้น)
function updateAllTabContent(filterKey) {
    const data = filterData[filterKey] || allData;
    
    document.getElementById('filter-title').textContent = 'ทั้งหมด';
    
    // อัปเดตส่วนหัวของ Card: จำนวนรายการ และ ยอดรวมคงเหลือ
    document.getElementById('item-count').textContent = `${data.itemCount} รายการ`;
    
    const netAmountDisplayEl = document.getElementById('net-amount-display');
    netAmountDisplayEl.textContent = `${data.netAmount.toLocaleString('th-TH')} THB`;
    netAmountDisplayEl.className = `net-amount-display ${data.netAmountClass}`; 
    
    // อัปเดตส่วนสรุปด้านล่าง: รายการและยอดเงิน
    document.getElementById('income-count').textContent = `${data.incomeCount} รายการ`;
    document.getElementById('income-amount-display').textContent = `${data.incomeAmount.toLocaleString('th-TH')} THB`; 
    
    document.getElementById('expense-count').textContent = `${data.expenseCount} รายการ`;
    document.getElementById('expense-amount-display').textContent = `${data.expenseAmount.toLocaleString('th-TH')} THB`; 
    

    // อัปเดต Chart
    if (myChart) {
        const income = data.incomeAmount;
        const expense = data.expenseAmount;
        
        if (income === 0 && expense === 0) {
            myChart.data.datasets[0].data = [1, 1];
            myChart.data.datasets[0].backgroundColor = ['#eee', '#eee'];
        } else {
             // ถ้ามีค่า ให้ใช้ค่าจริง
            myChart.data.datasets[0].data = [income, expense];
            myChart.data.datasets[0].backgroundColor = ['#a8e6a1', '#f6a5a5'];
        }
        myChart.update();
    }
}

// Chart.js initialization
function initChart() {
    const ctx = document.getElementById('myChart').getContext('2d');
    myChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['รายรับ', 'รายจ่าย'],
            datasets: [{
                data: [allData.incomeAmount || 1, allData.expenseAmount || 1],
                backgroundColor: allData.incomeAmount === 0 && allData.expenseAmount === 0 ? ['#eee', '#eee'] : ['#a8e6a1', '#f6a5a5'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, 
            plugins: {
                legend: {
                    display: true,
                    position: 'right', 
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 20,
                        font: {
                            family: 'Kanit, sans-serif'
                        }
                    }
                },
                tooltip: {
                    bodyFont: {
                        family: 'Kanit, sans-serif'
                    },
                    titleFont: {
                        family: 'Kanit, sans-serif'
                    },
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            const value = context.parsed;
                            return `${label}: ${value.toLocaleString('th-TH')} THB`;
                        }
                    }
                }
            }
        }
    });
}

// *** 2. ฟังก์ชันสร้าง Calendar Card ที่ดึงข้อมูลจาก transactions ***
function generateCalendarCard(dateObj, allTransactions) {
    const year = dateObj.getFullYear();
    const month = dateObj.getMonth(); 
    const today = new Date();

    // 1. คำนวณยอดรวมรายรับ/รายจ่ายประจำเดือน
    const monthTransactions = allTransactions.filter(t => 
        t.date.getFullYear() === year && t.date.getMonth() === month
    );
    
    const monthSummary = calculateSummary(monthTransactions);
    
    // 2. คำนวณยอดรวมรายรับ/รายจ่ายรายวัน 
    const dailySummary = monthTransactions.reduce((acc, t) => {
        const day = t.date.getDate();
        if (!acc[day]) acc[day] = { income: 0, expense: 0 };
        
        if (t.type === 'income') {
            acc[day].income += t.amount;
        } else {
            acc[day].expense += t.amount;
        }
        return acc;
    }, {});


    // 3. สร้างโครงสร้างปฏิทิน
    const firstDayOfMonth = new Date(year, month, 1);
    const firstDayOfNextMonth = new Date(year, month + 1, 1); 
    const lastDayOfMonth = new Date(firstDayOfNextMonth - 1); 
    const daysInMonth = lastDayOfMonth.getDate(); 
    const firstDayWeekday = firstDayOfMonth.getDay(); // 0=อาทิตย์, 1=จันทร์
    const lastDayOfPrevMonth = new Date(firstDayOfMonth - 1).getDate(); 
    
    const monthTitleText = `${monthNames[month]} ${year + 543}`; // ปีพุทธศักราช

    let html = `
    <div class="calendar-card">
      <div class="month-header">
        <h3 class="month-title">${monthTitleText}</h3>
        <div class="month-summary">
          <span class="income-text">${monthSummary.incomeAmount.toLocaleString('th-TH')} THB</span>
          <span class="expense-text">${monthSummary.expenseAmount.toLocaleString('th-TH')} THB</span>
          <span class="net-text">${monthSummary.netAmount.toLocaleString('th-TH')} THB</span>
        </div>
      </div>
      
      <div class="calendar-grid">
        <span class="day-header">อา</span>
        <span class="day-header">จ</span>
        <span class="day-header">อ</span>
        <span class="day-header">พ</span>
        <span class="day-header">พฤ</span>
        <span class="day-header">ศ</span>
        <span class="day-header">ส</span>
    `;

    // เติมเต็มช่องว่างของเดือนก่อนหน้า
    for (let i = 0; i < firstDayWeekday; i++) {
        html += `<span class="day-cell inactive-month"><span class="date-num">${lastDayOfPrevMonth - (firstDayWeekday - 1) + i}</span></span>`;
    }

    // ใส่เซลล์ของเดือนปัจจุบัน + ข้อมูลธุรกรรมจริง
    for (let day = 1; day <= daysInMonth; day++) {
        const isToday = (year === today.getFullYear() && month === today.getMonth() && day === today.getDate());
        const todayClass = isToday ? ' current-date' : '';
        
        const summary = dailySummary[day] || { income: 0, expense: 0 };
        
        // FIX: แสดงจำนวนเงินที่คำนวณได้จริงในช่องปฏิทิน
        const incomeHTML = summary.income > 0 ? `<span class="income-value">${summary.income.toLocaleString('th-TH')}</span>` : '';
        const expenseHTML = summary.expense > 0 ? `<span class="expense-value">${summary.expense.toLocaleString('th-TH')}</span>` : '';

        html += `
        <span class="day-cell${todayClass}">
          <span class="date-num">${day}</span>
          ${incomeHTML}
          ${expenseHTML}
        </span>
        `;
    }

    // เติมเต็มช่องว่างของเดือนถัดไป
    const totalCells = firstDayWeekday + daysInMonth;
    const remainingCells = (Math.ceil(totalCells / 7) * 7) - totalCells; // คำนวณให้เต็มแถวสุดท้าย
    
    for (let i = 1; i <= remainingCells; i++) {
        html += `<span class="day-cell inactive-month"><span class="date-num">${i}</span></span>`;
    }
    
    html += `
      </div>
    </div>
    `;
    
    return html;
}

// *** 3. ฟังก์ชันหลักสำหรับแสดงปฏิทินที่ขยายช่วงเดือน ***
function renderRealtimeCalendar() {
    const allTransactions = getTransactions();
    const today = new Date();
    
    const currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const prevMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
    
    const monthsToShow = new Set();
    
    monthsToShow.add(`${prevMonth.getFullYear()}-${prevMonth.getMonth()}`);
    monthsToShow.add(`${currentMonth.getFullYear()}-${currentMonth.getMonth()}`);
    monthsToShow.add(`${nextMonth.getFullYear()}-${nextMonth.getMonth()}`);
    
    // เพิ่มเดือนที่มีรายการ transactions อยู่ด้วย
    allTransactions.forEach(t => {
        if (t.date instanceof Date && !isNaN(t.date)) {
             monthsToShow.add(`${t.date.getFullYear()}-${t.date.getMonth()}`);
        }
    });
    
    const sortedMonths = Array.from(monthsToShow).map(m => {
        const [year, month] = m.split('-').map(Number);
        return new Date(year, month, 1);
    }).sort((a, b) => a - b);


    const container = document.getElementById('calendar-cards-container');
    container.innerHTML = ''; 

    sortedMonths.forEach(monthDate => {
        container.innerHTML += generateCalendarCard(monthDate, allTransactions);
    });
    
    // 5. อัปเดตปุ่ม Filter amounts
    updateFilterButtonAmounts();
}


// *** ฟังก์ชันสำหรับจัดการการคลิกปุ่ม Tab (ทั่วไป/รายจ่าย/รายรับ) ***
function setActiveTab(clickedElement, tabKey) {
    const tabs = document.querySelectorAll('.tabs button');
    tabs.forEach(button => {
        button.classList.remove('active');
    });
    clickedElement.classList.add('active');
    
    document.getElementById('all-content').style.display = 'none';
    document.getElementById('expense-content').style.display = 'none';
    document.getElementById('income-content').style.display = 'none';

    // *** NEW: อัปเดต filterData ทุกครั้งที่เปลี่ยน Tab ***
    const allTransactions = getTransactions();
    filterData['all'] = calculateSummary(allTransactions);
    filterData['today'] = calculateSummary(allTransactions.filter(t => {
        const today = new Date();
        return t.date.getDate() === today.getDate() && t.date.getMonth() === today.getMonth() && t.date.getFullYear() === today.getFullYear();
    }));
    filterData['month'] = calculateSummary(allTransactions.filter(t => {
        const today = new Date();
        return t.date.getMonth() === today.getMonth() && t.date.getFullYear() === today.getFullYear();
    }));
    updateFilterButtonAmounts(); // รีเฟรชปุ่ม

    if (tabKey === 'all') {
        document.getElementById('all-content').style.display = 'block';
        updateAllTabContent(currentActiveFilter); 
    } else if (tabKey === 'expense') {
        document.getElementById('expense-content').style.display = 'block';
        renderCategoryContent('expense', currentActiveFilter);
    } else if (tabKey === 'income') {
        document.getElementById('income-content').style.display = 'block';
        renderCategoryContent('income', currentActiveFilter);
    }
    
    currentActiveTab = tabKey;
}

// *** ฟังก์ชันสำหรับจัดการการคลิกปุ่มตัวกรอง (Filters) ***
function setActiveFilter(clickedElement, filterKey) {
    const filters = document.querySelectorAll('.filters button');
    filters.forEach(button => {
        button.classList.remove('active-filter');
    });
    clickedElement.classList.add('active-filter');

    const summaryView = document.getElementById('summary-view');
    const calendarView = document.getElementById('calendar-view');
    
    currentActiveFilter = filterKey;

    if (filterKey === 'calendar') {
        // แสดงหน้าปฏิทิน
        summaryView.style.display = 'none';
        calendarView.style.display = 'block';
        renderRealtimeCalendar(); 
    } else {
        // แสดงหน้าสรุป
        calendarView.style.display = 'none';
        summaryView.style.display = 'block';
        
        if (currentActiveTab === 'all') {
            updateAllTabContent(filterKey);
        } else if (currentActiveTab === 'expense') {
            renderCategoryContent('expense', filterKey);
        } else if (currentActiveTab === 'income') {
            renderCategoryContent('income', filterKey);
        }
    }
}

// ฟังก์ชันสำหรับกลับไปหน้าสรุป
function showSummaryView() {
    document.getElementById('calendar-view').style.display = 'none';
    document.getElementById('summary-view').style.display = 'block';

    const allTab = document.querySelector('.tabs button:first-child');
    setActiveTab(allTab, 'all'); 

    const allFilter = document.querySelector('#date-filters button:first-child');
    setActiveFilter(allFilter, 'all'); 
}

// ฟังก์ชันสำหรับจัดการการคลิกไอคอน (Bottom Nav)
function setActiveIcon(clickedElement) {
    const icons = document.querySelectorAll('.nav-icon');
    icons.forEach(icon => {
        icon.classList.remove('active-icon');
    });
    clickedElement.classList.add('active-icon');
}

// เริ่มต้น Chart และข้อมูลเริ่มต้นเมื่อโหลดหน้าเว็บเสร็จ
window.onload = function() {
    initChart();
    
    // โหลดข้อมูลและคำนวณใหม่เมื่อ DOM พร้อม
    const allTransactions = getTransactions();
    filterData['all'] = calculateSummary(allTransactions);
    filterData['today'] = calculateSummary(allTransactions.filter(t => {
        const today = new Date();
        return t.date.getDate() === today.getDate() && t.date.getMonth() === today.getMonth() && t.date.getFullYear() === today.getFullYear();
    }));
    filterData['month'] = calculateSummary(allTransactions.filter(t => {
        const today = new Date();
        return t.date.getMonth() === today.getMonth() && t.date.getFullYear() === today.getFullYear();
    }));
    
    updateAllTabContent('all'); 
    renderRealtimeCalendar(); // จะเรียก updateFilterButtonAmounts() ข้างใน
    
    const today = new Date();
    const monthFilterBtn = document.getElementById('month-filter-btn');
    // ตั้งค่าข้อความเริ่มต้น
    monthFilterBtn.textContent = `${monthNames[today.getMonth()]} ${today.getFullYear() + 543}`;
    
    // อัปเดตปุ่มด้วยจำนวนเงิน
    updateFilterButtonAmounts();
};
</script>

</body>
</html>